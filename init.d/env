#!/bin/bash

# This script initializes the configuration environment varibles.

load_env() {
	DIR_BASE=$(readlink -e `dirname $0`/..)
	CONF_BASE="${DIR_BASE}/conf.d/$( basename $(readlink -e $0))"
	source "${CONF_BASE}"

	IPTABLES=`which iptables 2>/dev/null` ||
		IPTABLES=/sbin/iptables

	IPTABLES_6=`which ip6tables 2>/dev/null` ||
		IPTABLES_6=/sbin/ip6tables

	local INTERFACES="$(netstat -i | tail -n+3 | awk '{print $1}')"
	local IF
	for IF in $INTERFACES; do
		load_if
	done

	load_args_ping

	local CHAINS="output input postrouting prerouting forward"
	for C in $CHAINS; do
		load_chain "$C"
	done
}

load_if() {
	local IPV=4
	local SEP="/"
	SUBNET[$IF]=$(ip -o -$IPV address | grep " ${IF} "  | awk '{print $4}')
	LOCAL[$IF]=${SUBNET[$IF]%${SEP}*}
	GATEWAY[$IF]=$(ip -o -$IPV route | grep " ${IF} " | grep " via " | awk '{print $3}')

	IPV=6
	SUBNET_6[$IF]=$(ip -o -$IPV address | grep " ${IF} "  | awk '{print $4}')
	LOCAL_6[$IF]=${SUBNET_6[$IF]%${SEP}*}
	GATEWAY_6[$IF]=$(ip -o -$IPV route | grep " ${IF} " | grep " via " | awk '{print $3}')

	load_if_masq
}

load_if_masq() {
  MASQ_IN[$IF]="${IPTABLES} -A prerouting -t mangle -i ${IF} -j MARK --set-mark"
	MASQ_OUT[$IF]="${IPTABLES} -A postrouting -t nat -o ${IF} -m mark -j MASQUERADE --mark"
	MASQ_IN[$IF]="${IPTABLES_6} -A prerouting -t mangle -i ${IF} -j MARK --set-mark"
	MASQ_OUT[$IF]="${IPTABLES_6} -A postrouting -t nat -o ${IF} -m mark -j MASQUERADE --mark"
}

load_args_ping() {
	PING_REQUEST="--protocol icmp --icmp-type echo-request"
	PING_REPLY="--protocol icmp --icmp-type echo-reply"
}

load_env
