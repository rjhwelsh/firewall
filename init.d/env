#!/bin/bash

# This script initializes the configuration environment varibles.

load_env() {
	DIR_BASE=$(readlink -e `dirname $0`/..)
	CONF_BASE="${DIR_BASE}/conf.d/$( basename $(readlink -e $0))"
	source "${CONF_BASE}"

	IPTABLES=`which iptables 2>/dev/null` ||
		IPTABLES=/sbin/iptables

	IPTABLES_6=`which ip6tables 2>/dev/null` ||
		IPTABLES_6=/sbin/ip6tables

	local INTERFACES="$(netstat -i | tail -n+3 | awk '{print $1}')"
	local IF
	for IF in $INTERFACES; do
		load_if
	done

	load_args_ping

	local CHAINS="output input postrouting prerouting forward"
	for C in $CHAINS; do
		load_chain "$C"
	done
}

load_if() {
	local IPV=4
	local SEP="/"
	SUBNET[$IF]=$(ip -o -$IPV address | grep " ${IF} "  | awk '{print $4}')
	LOCAL[$IF]=${SUBNET[$IF]%${SEP}*}
	GATEWAY[$IF]=$(ip -o -$IPV route | grep " ${IF} " | grep " via " | awk '{print $3}')

	IPV=6
	SUBNET_6[$IF]=$(ip -o -$IPV address | grep " ${IF} "  | awk '{print $4}')
	LOCAL_6[$IF]=${SUBNET_6[$IF]%${SEP}*}
	GATEWAY_6[$IF]=$(ip -o -$IPV route | grep " ${IF} " | grep " via " | awk '{print $3}')

	load_if_masq
	load_if_policy
}

load_if_masq() {
  MASQ_IN[$IF]="${IPTABLES} -A prerouting -t mangle -i ${IF} -j MARK --set-mark"
	MASQ_OUT[$IF]="${IPTABLES} -A postrouting -t nat -o ${IF} -m mark -j MASQUERADE --mark"
	MASQ_IN[$IF]="${IPTABLES_6} -A prerouting -t mangle -i ${IF} -j MARK --set-mark"
	MASQ_OUT[$IF]="${IPTABLES_6} -A postrouting -t nat -o ${IF} -m mark -j MASQUERADE --mark"
}

load_args_ping() {
	PING_REQUEST="--protocol icmp --icmp-type echo-request"
	PING_REPLY="--protocol icmp --icmp-type echo-reply"
}

load_if_policy() {
	POLICY[$IF]=${DEFAULT_POLICY}
	}

load_chain() {
	local CHAIN="$1"
	CHAIN="${CHAIN^^}"
	JUMP[$CHAIN]=${DEFAULT_JUMP}
	POLICY[$CHAIN]=${DEFAULT_POLICY}
	I[${CHAIN}]="${IPTABLES} --append ${CHAIN}"
	A[${CHAIN}]="${IPTABLES} --insert ${CHAIN}"

	# IPv6
	JUMP_6[$CHAIN]=${DEFAULT_JUMP_6}
	POLICY_6[$CHAIN]=${DEFAULT_POLICY_6}
	I_6[${CHAIN}]="${IPTABLES_6} --append ${CHAIN}"
	A_6[${CHAIN}]="${IPTABLES_6} --insert ${CHAIN}"
	}

# Declare arrays
declare -A MASQ_IN MASQ_OUT
declare -A MASQ_IN_6 MASQ_OUT_6

declare -A SUBNET LOCAL GATEWAY
declare -A SUBNET_6 LOCAL_6 GATEWAY_6

declare -A JUMP POLICY I A
declare -A JUMP_6 POLICY_6 I_6 A_6

load_env
